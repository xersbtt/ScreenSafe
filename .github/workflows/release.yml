name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app (no signing)
        run: npm run tauri build -- --no-bundle
        
      - name: Build NSIS installer
        run: npm run tauri build -- --bundles nsis

      - name: Prepare release files
        shell: powershell
        run: |
          # Create release directory
          New-Item -ItemType Directory -Force -Path "release/ScreenSafe"
          
          # Copy the NSIS installer
          $nsisExe = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis/*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($nsisExe) {
            Write-Host "Found NSIS installer: $($nsisExe.FullName)"
            Copy-Item $nsisExe.FullName -Destination "release/"
          } else {
            Write-Host "No NSIS installer found"
          }
          
          # Copy portable executable
          $exePath = "src-tauri/target/release/ScreenSafe.exe"
          if (Test-Path $exePath) {
            Write-Host "Copying main executable"
            Copy-Item $exePath -Destination "release/ScreenSafe/"
          } else {
            Write-Host "ERROR: Main executable not found at $exePath"
            exit 1
          }
          
          # Copy Python sidecar
          Write-Host "Copying Python sidecar"
          Copy-Item -Path "python" -Destination "release/ScreenSafe/python" -Recurse
          
          # Copy assets
          if (Test-Path "assets") {
            Write-Host "Copying assets"
            Copy-Item -Path "assets" -Destination "release/ScreenSafe/assets" -Recurse
          }
          
          # Create portable zip
          Write-Host "Creating portable ZIP"
          Compress-Archive -Path "release/ScreenSafe/*" -DestinationPath "release/ScreenSafe-${{ github.ref_name }}-windows-x64-portable.zip"
          
          Write-Host "Release files prepared successfully"
          Get-ChildItem -Path "release" -Recurse

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            release/*.zip
            release/*.exe

  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app for Apple Silicon
        run: npm run tauri build -- --target aarch64-apple-darwin
        env:
          # Skip code signing for unsigned build
          TAURI_SIGNING_PRIVATE_KEY: ""

      - name: Build Tauri app for Intel Mac
        run: npm run tauri build -- --target x86_64-apple-darwin
        env:
          TAURI_SIGNING_PRIVATE_KEY: ""

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # === ARM64 Build ===
          ARM_APP=$(find src-tauri/target/aarch64-apple-darwin/release/bundle/macos -name "*.app" 2>/dev/null | head -1)
          if [ -d "$ARM_APP" ]; then
            echo "Found ARM64 app: $ARM_APP"
            
            # Copy Python sidecar INSIDE the .app bundle (where Rust expects it)
            cp -R python "$ARM_APP/Contents/MacOS/python"
            echo "Copied Python sidecar into $ARM_APP/Contents/MacOS/python"
            
            # Copy assets into the app bundle
            [ -d "assets" ] && cp -R assets "$ARM_APP/Contents/MacOS/assets"
            
            # Rebuild DMG with the modified .app bundle (original DMG was built before Python was added)
            echo "Rebuilding ARM64 DMG with Python sidecar..."
            cd src-tauri/target/aarch64-apple-darwin/release/bundle
            rm -f dmg/*.dmg
            hdiutil create -volname "ScreenSafe" -srcfolder macos -ov -format UDZO "dmg/ScreenSafe-arm64.dmg"
            cd -
          fi
          
          # Copy rebuilt ARM64 DMG
          ARM_DMG=$(find src-tauri/target/aarch64-apple-darwin/release/bundle/dmg -name "*.dmg" 2>/dev/null | head -1)
          if [ -n "$ARM_DMG" ]; then
            echo "Found ARM64 DMG: $ARM_DMG"
            cp "$ARM_DMG" "release/ScreenSafe-${{ github.ref_name }}-macos-arm64.dmg"
          fi
          
          # === x86_64 Build ===
          X86_APP=$(find src-tauri/target/x86_64-apple-darwin/release/bundle/macos -name "*.app" 2>/dev/null | head -1)
          if [ -d "$X86_APP" ]; then
            echo "Found x86_64 app: $X86_APP"
            
            # Copy Python sidecar INSIDE the .app bundle
            cp -R python "$X86_APP/Contents/MacOS/python"
            echo "Copied Python sidecar into $X86_APP/Contents/MacOS/python"
            
            # Copy assets into the app bundle
            [ -d "assets" ] && cp -R assets "$X86_APP/Contents/MacOS/assets"
            
            # Rebuild DMG with the modified .app bundle
            echo "Rebuilding x86_64 DMG with Python sidecar..."
            cd src-tauri/target/x86_64-apple-darwin/release/bundle
            rm -f dmg/*.dmg
            hdiutil create -volname "ScreenSafe" -srcfolder macos -ov -format UDZO "dmg/ScreenSafe-x64.dmg"
            cd -
          fi
          
          # Copy rebuilt x86_64 DMG
          X86_DMG=$(find src-tauri/target/x86_64-apple-darwin/release/bundle/dmg -name "*.dmg" 2>/dev/null | head -1)
          if [ -n "$X86_DMG" ]; then
            echo "Found x86_64 DMG: $X86_DMG"
            cp "$X86_DMG" "release/ScreenSafe-${{ github.ref_name }}-macos-x64.dmg"
          fi
          
          # Create portable ZIP with the MODIFIED .app bundle for ARM64
          if [ -d "src-tauri/target/aarch64-apple-darwin/release/bundle/macos" ]; then
            mkdir -p release/macos-arm64
            cp -R src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app release/macos-arm64/
            cd release && zip -r "ScreenSafe-${{ github.ref_name }}-macos-arm64-portable.zip" macos-arm64 && cd ..
            rm -rf release/macos-arm64
          fi
          
          # Create portable ZIP for x86_64
          if [ -d "src-tauri/target/x86_64-apple-darwin/release/bundle/macos" ]; then
            mkdir -p release/macos-x64
            cp -R src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app release/macos-x64/
            cd release && zip -r "ScreenSafe-${{ github.ref_name }}-macos-x64-portable.zip" macos-x64 && cd ..
            rm -rf release/macos-x64
          fi
          
          echo "Release files prepared:"
          ls -la release/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            release/*.dmg
            release/*.zip

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: release

      - name: List downloaded files
        run: ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ScreenSafe ${{ github.ref_name }}
          body: |
            ## ScreenSafe ${{ github.ref_name }}
            
            Privacy-first video redaction tool - automatically detect and blur sensitive information in screen recordings.
            
            ### Windows Downloads
            - **Portable ZIP**: Contains executable + Python sidecar. Extract and run `ScreenSafe.exe`
            - **Installer**: Standard Windows installer (.exe)
            
            ### macOS Downloads
            - **DMG (ARM64)**: For Apple Silicon Macs (M1/M2/M3/M4)
            - **DMG (x64)**: For Intel Macs
            - **Portable ZIP**: Contains .app bundle + Python sidecar
            
            > ⚠️ **macOS Note**: This is an unsigned build. On first launch, right-click the app and select "Open" to bypass Gatekeeper.
            
            ### Requirements
            - **Windows**: Windows 10/11 (x64), Python 3.10+
            - **macOS**: macOS 11+ (Big Sur or later), Python 3.10+
            
            See [CHANGELOG.md](https://github.com/xersbtt/ScreenSafe/blob/main/CHANGELOG.md) for details.
          files: |
            release/*.zip
            release/*.exe
            release/*.dmg
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
