name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app (no signing)
        run: npm run tauri build -- --no-bundle
        
      - name: Build NSIS installer
        run: npm run tauri build -- --bundles nsis

      - name: Prepare release files
        shell: powershell
        run: |
          # Create release directory
          New-Item -ItemType Directory -Force -Path "release/ScreenSafe"
          
          # Copy the NSIS installer
          $nsisExe = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis/*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($nsisExe) {
            Write-Host "Found NSIS installer: $($nsisExe.FullName)"
            Copy-Item $nsisExe.FullName -Destination "release/"
          } else {
            Write-Host "No NSIS installer found"
          }
          
          # Copy portable executable
          $exePath = "src-tauri/target/release/ScreenSafe.exe"
          if (Test-Path $exePath) {
            Write-Host "Copying main executable"
            Copy-Item $exePath -Destination "release/ScreenSafe/"
          } else {
            Write-Host "ERROR: Main executable not found at $exePath"
            exit 1
          }
          
          # Copy Python sidecar
          Write-Host "Copying Python sidecar"
          Copy-Item -Path "python" -Destination "release/ScreenSafe/python" -Recurse
          
          # Copy assets
          if (Test-Path "assets") {
            Write-Host "Copying assets"
            Copy-Item -Path "assets" -Destination "release/ScreenSafe/assets" -Recurse
          }
          
          # Create portable zip
          Write-Host "Creating portable ZIP"
          Compress-Archive -Path "release/ScreenSafe/*" -DestinationPath "release/ScreenSafe-${{ github.ref_name }}-windows-x64-portable.zip"
          
          Write-Host "Release files prepared successfully"
          Get-ChildItem -Path "release" -Recurse

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            release/*.zip
            release/*.exe

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release

      - name: List downloaded files
        run: ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ScreenSafe ${{ github.ref_name }}
          body: |
            ## ScreenSafe ${{ github.ref_name }}
            
            Privacy-first video redaction tool - automatically detect and blur sensitive information in screen recordings.
            
            ### Downloads
            - **Portable ZIP**: Contains executable + Python sidecar. Extract and run `ScreenSafe.exe`
            - **Installer** (if available): Standard Windows installer
            
            ### Requirements
            - Windows 10/11 (x64)
            - Python 3.10+ (with EasyOCR for OCR features)
            
            See [CHANGELOG.md](https://github.com/xersbtt/ScreenSafe/blob/main/CHANGELOG.md) for details.
          files: |
            release/*.zip
            release/*.exe
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
